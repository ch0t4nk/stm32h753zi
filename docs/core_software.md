# Core Software

> **Anchors**:  
> - **SSOT** – `src/config/ssot.yaml`  
> - **STATUS** – `docs/STATUS.md`  
> - **ARCHIVE** – `archive/outdated_docs/DOCS_BKUP_08-18-2025`  
> - **DOMAINS** – `core_software.md`, `communications.md`, `telemetry.md`, `motor_control.md`, `safety.md`, `build_testing.md`, `simulation.md`, `documentation_ssot.md`

---

## Overview

The *Core Software* domain governs the firmware running on the STM32H753ZI MCU, orchestrating real‑time operations for power‑train control, safety, telemetry, and communication. It is a tightly coupled, **RTOS‑based** stack that blends the following:

| Layer | Technology | Purpose |
|-------|------------|---------|
| **Hardware Abstraction** | STM32Cube HAL | Register‑level peripheral access |
| **Operating System** | FreeRTOS | Threading, synchronization, timing |
| **Middleware** | X‑CUBE‑SPN2 + MCSDK hybrid | CAN, LIN, and proprietary serial stacks |
| **Build System** | CMake (Ninja) + ARM GCC | Cross‑compilation, dependency tracking |
| **CI/Automation** | PowerShell / Python scripts | Host‑test, flash, and validation pipelines |

The code base is split into feature modules (`motor_control`, `telemetry`, `safety`, etc.) while a *single source of truth* (SSOT) drives configuration and header generation.

---

## Detailed Description

### 1. Project Architecture

- **HAL Layer** – All peripheral drivers are sourced from the STM32Cube repository. The `src/config/hardware_config.h` (generated by the SSOT manifest) drives pin mapping, clock trees, and peripheral enable flags.
- **RTOS Layer** – FreeRTOS runs on the Cortex‑M7 core. Priority‑based preemption ensures deterministic control of motor loops, safety watchdogs, and telemetry uplinks.
- **Middleware** – The X‑CUBE‑SPN2 stack handles high‑speed CAN and LIN buses, while the MCSDK provides custom serial framing for the host interface.
- **Application Layer** – Feature‑specific code (e.g., PID loops, state machines) resides in `src/motor_control/`, `src/telemetry/`, `src/safety/`. Each module exposes an init/loop API that the main FreeRTOS scheduler pulls.
- **Build Pipeline** – CMake reads `CMakePresets.json` (Debug/Release, host/test). The ARM GCC toolchain (`STM32CubeCLT 1.19.0`) is automatically discovered via `scripts/Get-WorkflowToolchain.ps1`. Workspace configuration (`src/config/workspace_config.h`) is injected at build time, ensuring every developer uses the same SSOT.

### 2. Key Functional Blocks

| Block | Responsibility | Interfaces |
|-------|----------------|------------|
| **Powertrain Control** | Sensor acquisition, torque calculation, PWM generation | I2C, SPI, TIM, DAC |
| **Safety Monitors** | Fault detection, watchdog reset, abort procedures | GPIO, SYSRESTART |
| **Telemetry** | Data logging, diagnostic dumps, host‑test reporting | CAN, UART, SDIO |
| **Host‑Interface** | Firmware updates, configuration changes, status queries | UART, USB CDC |

### 3. Testing Strategy

- **Unit Tests** – Executed in a *host test* harness (`build_host_tests`) compiled with a native compiler. Mocks replace HAL calls; tests validate algorithmic correctness independent of hardware.
- **Integration Tests** – Run on the target MCU via `STM32_Programmer_CLI.exe` (or env‑override `STM32_PROGRAMMER_CLI`). Scripts such as `validate_hse_hardware.ps1` and `apply_hse_fix.ps1` ensure clock trees are correct before each test run.
- **Continuous Integration** – GitHub Actions trigger the CMake build, run host tests, flash the device, and collect logs. The `STATUS.md` file is updated automatically (post‑commit) to reflect the latest build health.

---

## Algorithm Details

### 1. Motor Control PID

The PID controller runs at **1 kHz** inside the motor task:

```c
// Pseudocode
float pid_update(float setpoint, float measured) {
    float error = setpoint - measured;
    integral += error * dt;
    derivative = (error - prev_error) / dt;
    prev_error = error;
    return Kp * error + Ki * integral + Kd * derivative;
}
```

- **Anti‑windup**: Integral term is clamped to `I_MAX`.
- **Feed‑forward**: Torque feed‑forward (`Kff * speed_ref`) added to improve dynamic response.
- **Deadband**: A small deadband around zero avoids unnecessary PWM activity.

### 2. Safety Watchdog

The watchdog is serviced every **100 ms**:

```c
if (!watchdog_ok()) {
    // Force a hard reset
    NVIC_SystemReset();
}
```

- **Safety State Machine**: Transitions between `NORMAL`, `ALARM`, `FAILSAFE`. Each state has a timeout; exceeding a timeout triggers a system reset.
- **Fault Signaling**: Faults are reported over CAN and stored in non‑volatile memory for post‑mortem.

### 3. Telemetry Frame Encoding

Telemetry uses a 12‑bit CRC and a 1 byte header:

```c
uint8_t tx[FRAME_LEN];
tx[0] = FRAME_HEADER;
memcpy(tx+1, payload, PAYLOAD_LEN);
tx[FRAME_LEN-1] = crc12_calc(tx, FRAME_LEN-1);
```

- CRC calculated with the polynomial `0x0CF` (12‑bit).
- Frames are queued in a FreeRTOS queue and transmitted by a dedicated `TelemetryTask`.

---

## Best Practices

| Area | Recommendation | Reason |
|------|----------------|--------|
| **Source Control** | All source in `src/`, configs in `src/config/` | Centralizes changes, enables SSOT |
| **Configuration Management** | Use `ssot.yaml` to generate headers; keep `workspace_config.h` in source tree | Guarantees identical builds across devs |
| **Build** | CMake presets (`Debug`, `Release`) and Ninja generator | Fast incremental builds, reproducible |
| **Testing** | Separate host and target test harnesses; keep mocks in `tests/mocks/` | Isolates hardware dependencies |
| **Documentation** | Inline Doxygen comments + domain docs; refer to `STATUS.md` for health | Keeps docs up‑to‑date with minimal friction |
| **CI** | GitHub Actions + PowerShell scripts; auto‑update `STATUS.md` | Continuous visibility of build health |
| **Safety** | Explicit `assert()` checks in critical paths; compile with `-fsanitize=undefined` during debug | Early detection of undefined behavior |

---

## Reference Links

| Resource | Path | Description |
|----------|------|-------------|
| **SSOT Manifest** | `src/config/ssot.yaml` | Central configuration source for all header files |
| **Build Status** | `docs/STATUS.md` | Current build health, toolchain, and deployment notes |
| **Legacy Docs** | `archive/outdated_docs/DOCS_BKUP_08-18-2025` | Historical reference for earlier releases |
| **Domain Docs** | `docs/core_software.md` | This document |
| **Documentation SSOT** | `docs/documentation_ssot.md` | SSOT‑driven docs generation process |
| **Automation Scripts** | `scripts/` | Build, flash, and validation utilities |
| **Testing Harness** | `build_host_tests` | Host‑test build directory and CMakeLists |

---
