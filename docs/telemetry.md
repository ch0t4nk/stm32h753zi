# Telemetry Domain Documentation

## Overview
The **Telemetry** domain is responsible for collecting, processing, and transmitting sensor data from the STM32H753ZI firmware to host‑side applications or external subsystems. It interfaces with the HAL and FreeRTOS layers, and leverages the SSOT‑driven configuration to ensure consistent register maps and timing parameters across all build artifacts.

- **Primary header**: `src/config/telemetry_config.h` (see [SSOT](src/config/ssot.yaml))
- **Runtime API**: `TelemetryManager` (C/C++ API) exposing `init()`, `collect()`, `pack()`, and `send()` primitives.
- **Build status**: In‑progress; host‑test failures (9/17 telemetry tests) are being triaged (see [STATUS](docs/STATUS.md)).

## Detailed Description
Telemetry data flows through three major stages:

| Stage | Function | Notes |
|-------|----------|-------|
| **Acquisition** | Interrupt‑driven ADC/DMA reads, I²C/SPI sensor polls | Timed by a dedicated FreeRTOS task (`TelemetryTask`) or hardware timers |
| **Processing** | Filtering (moving‑average, Kalman), scaling, unit conversion | Configurable via telemetry_config.h; uses HAL helper functions |
| **Transmission** | Packet framing, CRC, queuing, UART/USB/Can send | Queued to an RTOS queue; DMA used for high‑throughput links |

The domain also defines a **Telemetry Frame** format:

```
[Header] 0xAA 0x55
[Length] 1 byte
[Type]   1 byte
[Payload] N bytes
[CRC]    2 bytes
```

All payloads are self‑describing with a type ID that maps to a struct definition (generated by `scripts/generate_telemetry_structs.py`).

## Algorithm Details
1. **Sampling Scheduler**  
   ```c
   void TelemetryTask(void *arg) {
       while (1) {
           telemetry_collect();   // ISR or DMA callback
           telemetry_process();   // filter, scale
           telemetry_queue();     // push to RTOS queue
           vTaskDelay(pdMS_TO_TICKS(telemetry_config.SAMPLE_PERIOD_MS));
       }
   }
   ```
   *Ensures deterministic sample rates.*

2. **Data Filtering**  
   - **Moving‑Average Filter**: Sliding window of last *N* samples.  
     ```c
     float ma_filter(float new_sample, float *buffer, uint8_t idx, uint8_t size) {
         buffer[idx] = new_sample;
         idx = (idx + 1) % size;
         float sum = 0;
         for (uint8_t i = 0; i < size; i++) sum += buffer[i];
         return sum / size;
     }
     ```
   - **Kalman Filter** (optional, toggled via SSOT flag).

3. **Packetization**  
   ```c
   TelemetryPacket packet = {
       .header = 0xAA55,
       .length = payload_len,
       .type = type_id,
       .payload = { ... },
   };
   packet.crc = crc16(&packet, sizeof(packet) - sizeof(packet.crc));
   telemetry_queue_put(&packet);
   ```

4. **Transmission**  
   - DMA‑based UART with double‑buffered FIFO.  
   - Error handling: CRC mismatch, FIFO overflow logged via `TelemetryError`.

All algorithmic parameters (filter order, buffer sizes, sample period) are pulled from `telemetry_config.h` to keep them centrally controlled.

## Best Practices
| Area | Recommendation | Why |
|------|----------------|-----|
| **Configuration** | Keep all telemetry constants in `telemetry_config.h`; use SSOT to sync across firmware, docs, and tests. | Centralizes change‑tracking; prevents drift. |
| **Timing** | Use hardware timers for sampling to avoid drift from `vTaskDelay()`. | Guarantees deterministic intervals. |
| **Buffering** | Employ ring buffers with wrap‑around detection; monitor queue depth. | Prevents data loss under load. |
| **CRC** | Always validate before unpacking; log checksum errors. | Detects transmission corruption early. |
| **Unit Testing** | Write isolated tests for `ma_filter()` and `crc16()`; run under host‑test harness. | Ensures algorithm correctness independent of hardware. |
| **Documentation** | Update telemetry domain doc whenever new sensor types or frame formats are added. | Maintains accurate reference for developers. |

## Reference Links
- **SSOT Manifest**: [src/config/ssot.yaml](/src/config/ssot.yaml)
- **Project Status**: [docs/STATUS.md](/docs/STATUS.md)
- **Telemetry Header**: [src/config/telemetry_config.h](/src/config/telemetry_config.h)
- **Telemetry API**: [src/telemetry/TelemetryManager.hpp](/src/telemetry/TelemetryManager.hpp)
- **Automation Scripts**: [scripts/generate_telemetry_structs.py](/scripts/generate_telemetry_structs.py)
- **Build Archive**: [archive/outdated_docs/DOCS_BKUP_08-18-2025](/archive/outdated_docs/DOCS_BKUP_08-18-2025)

---

**Note**: This document is part of the domain suite (`core_software.md`, `communications.md`, `motor_control.md`, `safety.md`, `build_testing.md`, `simulation.md`, `documentation_ssot.md`). Ensure it is kept in sync with any changes to telemetry headers or SSOT definitions.
